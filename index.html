<!DOCTYPE html>
<html lang="ru">
<head>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <title>AstikChat</title>
  <link rel="icon" type="image/png" href="icon.png">
  
  <meta name="theme-color" content="#3b82f6">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: #1f2937;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100dvh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overflow: hidden;
    }
    
    #app {
      width: 100%;
      max-width: 480px;
      height: 100dvh;
      max-height: 900px;
      background: #ffffff;
      border-radius: 32px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid #dbeafe;
    }
    
    #app::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 6px;
      background: #bfdbfe;
      border-radius: 3px;
      z-index: 10;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
      padding: 24px 20px 20px;
      color: white;
      font-size: 26px;
      font-weight: 700;
      text-align: center;
      position: relative;
      z-index: 5;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      letter-spacing: -0.5px;
    }
    
    .edit-nick {
      position: absolute;
      right: 20px;
      top: 24px;
      font-size: 18px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.2);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .edit-nick:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* Main Screen */
    #main {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    #chat-list {
      flex: 1;
      overflow-y: auto;
      background: #f0f9ff;
      padding: 12px 0;
    }
    
    .chat-item {
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      margin: 0 12px 8px;
      border-radius: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid #e0f2fe;
    }
    
    .chat-item:hover {
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .chat-item:active {
      background: #f0f9ff;
      transform: translateY(0);
    }
    
    /* –ê–≤–∞—Ç–∞—Ä–∫–∏ */
    .avatar {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 24px;
      flex-shrink: 0;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* –û–±—â–∏–π —á–∞—Ç - –æ—Å–æ–±—ã–π —Å—Ç–∏–ª—å */
    .chat-item:first-child .avatar {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    /* –û–±—ã—á–Ω—ã–µ —á–∞—Ç—ã */
    .private .avatar {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
    }
    
    .info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      font-size: 17px;
      font-weight: 600;
      color: #1e3a8a;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chat-item:first-child .chat-name::after {
      content: "üåê";
      font-size: 14px;
      background: #fef3c7;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .last-msg {
      font-size: 14px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .unread {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      min-width: 28px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    /* Chat Screen */
    #chat-screen {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    #chat-header {
      background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .back-btn {
      position: absolute;
      left: 20px;
      top: 18px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%);
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      max-width: 78%;
      padding: 14px 18px;
      border-radius: 24px;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      animation: messageAppear 0.3s ease-out;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .sent {
      align-self: flex-end;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border-bottom-right-radius: 8px;
      border: none;
    }
    
    .received {
      align-self: flex-start;
      background: white;
      color: #1f2937;
      border-bottom-left-radius: 8px;
    }
    
    .msg-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #3b82f6;
      opacity: 0.9;
    }
    
    .sent .msg-sender {
      display: none;
    }
    
    .msg-text {
      margin-bottom: 8px;
      font-size: 15.5px;
      line-height: 1.4;
    }
    
    .msg-time {
      font-size: 11.5px;
      opacity: 0.8;
      text-align: right;
      font-weight: 500;
    }
    
    .received .msg-time {
      color: #6b7280;
    }
    
    .sent .msg-time {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Input Bar */
    .input-bar {
      background: white;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-top: 1px solid #dbeafe;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }
    
    #msg-input {
      flex: 1;
      padding: 16px 22px;
      background: #f0f9ff;
      border: 2px solid #dbeafe;
      border-radius: 30px;
      color: #1e3a8a;
      font-size: 16px;
      outline: none;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    #msg-input:focus {
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    
    #msg-input::placeholder {
      color: #93c5fd;
    }
    
    #send-btn {
      width: 54px;
      height: 54px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    /* Welcome Screen */
    #welcome {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      text-align: center;
    }
    
    #welcome h1 {
      font-size: 52px;
      margin-bottom: 16px;
      color: white;
      font-weight: 800;
      letter-spacing: -1px;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, #ffffff 0%, #bfdbfe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    #welcome p {
      font-size: 18px;
      margin-bottom: 40px;
      color: rgba(255, 255, 255, 0.95);
      line-height: 1.6;
      max-width: 320px;
    }
    
    #welcome input {
      width: 100%;
      max-width: 340px;
      padding: 20px 24px;
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 22px;
      font-size: 18px;
      text-align: center;
      margin: 20px 0;
      outline: none;
      color: white;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
      font-weight: 500;
    }
    
    #welcome input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    #welcome input:focus {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.15);
    }
    
    #welcome button {
      padding: 20px 60px;
      background: white;
      color: #1d4ed8;
      border-radius: 40px;
      font-size: 19px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      margin-top: 20px;
    }
    
    #welcome button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }
    
    #welcome button:active {
      transform: translateY(0);
    }

    /* New Chat Button */
    .new-chat {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      width: 66px;
      height: 66px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      z-index: 50;
      transition: all 0.3s;
      border: 4px solid white;
    }
    
    .new-chat:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(219, 234, 254, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.4);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.6);
    }

    /* Responsive Adjustments */
    @media (max-width: 480px) {
      #app {
        border-radius: 0;
        max-height: 100dvh;
      }
      
      #app::before {
        display: none;
      }
      
      .new-chat {
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        font-size: 30px;
      }
      
      header {
        font-size: 24px;
        padding: 20px 20px 18px;
      }
      
      #welcome h1 {
        font-size: 48px;
      }
    }
  </style>
</head>
<body>

<div id="app">

<div id="welcome">
  <h1>AstikChat</h1>
  <p id="welcome-text">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
  
  <button id="google-btn" onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>

  <div id="nick-setup" style="display: none; width: 100%;">
    <input type="text" id="nameInput" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫" maxlength="15">
    <button onclick="saveNickname()">–ù–∞—á–∞—Ç—å –æ–±—â–∞—Ç—å—Å—è</button>
  </div>
</div>

  <div id="install-banner" style="display: none; background: #fff; padding: 15px; position: fixed; bottom: 0; width: 100%; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center;">
  <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AstikChat –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª!</p>
  <button id="install-button" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px; font-weight: bold;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <button id="close-banner" style="background: #e5e7eb; border: none; padding: 10px 20px; border-radius: 8px; margin-left: 10px;">–ü–æ–∑–∂–µ</button>
</div>

  
  <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
  <div id="main">
    <header>
      AstikChat
      <div class="edit-nick" onclick="changeName()">‚úé</div>
    </header>
    <div id="chat-list">
      <div class="chat-item" onclick="openPublic()">
        <div class="avatar">üåê</div>
        <div class="info">
          <div class="chat-name">–û–±—â–∏–π —á–∞—Ç</div>
          <div class="last-msg">–û–±—â–∞–π—Ç–µ—Å—å —Å–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat-screen">
    <div id="chat-header">
      <button class="back-btn" onclick="back()">‚Üê</button>
      <div class="avatar" id="partner-avatar">A</div>
      <div class="info">
        <div class="chat-name" id="partner-name">–ß–∞—Ç</div>
      </div>
    </div>
    <div id="chat-messages"></div>
    <div class="input-bar">
      <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="send-btn">‚Üë</button>
    </div>
  </div>

</div>

<!-- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–ö–†–ò–ü–¢ –° –ü–†–û–í–ï–†–ö–û–ô –ò–ú–ï–ù -->
<script>
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–≤–æ—è
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

let myName = ""; // –≠—Ç–æ –±—É–¥–µ—Ç –Ω–∞—à –Ω–∏–∫–Ω–µ–π–º
let myUid = "";
let currentChatId = null;
let replyTo = null;

// 1. –í–•–û–î –ß–ï–†–ï–ó GOOGLE
function login() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Redirect –≤–º–µ—Å—Ç–æ Popup
    auth.signInWithRedirect(provider).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
        alert("–ö–æ–¥ –æ—à–∏–±–∫–∏: " + error.code + "\n–°–æ–æ–±—â–µ–Ω–∏–µ: " + error.message);
    });
}

// –î–æ–±–∞–≤—å —ç—Ç–æ—Ç –±–ª–æ–∫, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ Firebase –∑–∞–≤–µ—Ä—à–∏–ª –≤—Ö–æ–¥
auth.getRedirectResult().then((result) => {
    if (result.user) {
        console.log("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ Redirect");
        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —á–∞—Ç —É–∂–µ –µ—Å—Ç—å –≤ onAuthStateChanged
    }
}).catch((error) => {
    if (error.code === 'auth/operation-not-supported-in-this-environment') {
        alert("–≠—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Google. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Chrome –∏–ª–∏ Safari.");
    } else {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:", error);
    }
});

// 2. –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –í–•–û–î–ê
auth.onAuthStateChanged((user) => {
    if (user) {
        myUid = user.uid;
        checkUserNickname(user.uid);
    } else {
        showWelcomeStep(1);
    }
});

// 3. –ü–†–û–í–ï–†–ö–ê: –ï–°–¢–¨ –õ–ò –£–ñ–ï –ù–ò–ö –£ –≠–¢–û–ì–û UID
function checkUserNickname(uid) {
    db.ref('users_by_uid/' + uid).once('value', (snap) => {
        if (snap.exists()) {
            myName = snap.val().nickname;
            enterChat();
        } else {
            showWelcomeStep(2); // –ï—Å–ª–∏ –Ω–∏–∫–∞ –Ω–µ—Ç, –ø—Ä–æ—Å–∏–º —Å–æ–∑–¥–∞—Ç—å
        }
    });
}

// 4. –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ò–ö–ê
async function saveNickname() {
    const input = document.getElementById('nameInput');
    const nick = input.value.trim().toLowerCase();
    
    if (nick.length < 3) return alert("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –Ω–∏–∫ –¥—Ä—É–≥–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º
    const existingNick = await db.ref('nicknames/' + nick).once('value');
    if (existingNick.exists()) {
        return alert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç, –ø—Ä–∏–¥—É–º–∞–π –¥—Ä—É–≥–æ–π!");
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑–∫—É UID -> Nick –∏ Nick -> UID
    const updates = {};
    updates['users_by_uid/' + myUid] = { nickname: nick, photo: auth.currentUser.photoURL };
    updates['nicknames/' + nick] = myUid;
    
    await db.ref().update(updates);
    myName = nick;
    enterChat();
}

// 5. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê –ü–†–ò –í–•–û–î–ï
function showWelcomeStep(step) {
    const googleBtn = document.getElementById('google-btn');
    const nickSetup = document.getElementById('nick-setup');
    const welcomeText = document.getElementById('welcome-text');

    if (step === 1) {
        googleBtn.style.display = 'block';
        nickSetup.style.display = 'none';
    } else {
        googleBtn.style.display = 'none';
        nickSetup.style.display = 'block';
        welcomeText.innerText = "–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ! –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±–µ –∏–º—è –¥–ª—è —á–∞—Ç–∞:";
    }
}

function enterChat() {
    document.getElementById('welcome').style.display = 'none';
    document.getElementById('main').style.display = 'flex';
    loadChats();
}

// 6. –û–¢–í–ï–¢ –ù–ê –°–û–û–ë–©–ï–ù–ò–ï (Double Click)
function setReply(name, text) {
    replyTo = { name, text };
    const input = document.getElementById('msg-input');
    input.placeholder = `–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${name}...`;
    input.focus();
}

// 7. –û–¢–ü–†–ê–í–ö–ê
function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text) return;

    const msg = {
        name: myName,
        uid: myUid,
        text: text,
        time: Date.now()
    };
    if (replyTo) msg.reply = replyTo;

    if (currentChatId === 'public') {
        db.ref('public_messages').push(msg);
    } else {
        db.ref(`private_chats/${currentChatId}/messages`).push(msg);
        db.ref(`private_chats/${currentChatId}`).update({
            lastMsg: text.substring(0, 40),
            lastTime: Date.now()
        });
    }

    input.value = '';
    input.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
    replyTo = null;
}

// 8. –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
function listenToMessages(path) {
    const container = document.getElementById('chat-messages');
    container.innerHTML = '';
    db.ref(path).off(); // –°–±—Ä–æ—Å —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    db.ref(path).limitToLast(50).on('child_added', s => {
        const m = s.val();
        const isMe = m.uid === myUid;
        const div = document.createElement('div');
        div.className = `message ${isMe ? 'sent' : 'received'}`;
        
        div.ondblclick = () => setReply(m.name, m.text);

        let replyHtml = m.reply ? `
            <div style="background: rgba(0,0,0,0.08); padding: 5px 8px; border-left: 3px solid #3b82f6; font-size: 12px; margin-bottom: 5px; border-radius: 4px; color: inherit;">
                <strong>${m.reply.name}</strong><br>${m.reply.text}
            </div>` : '';

        div.innerHTML = `
            ${replyHtml}
            <div class="msg-sender" style="${isMe ? 'display:none' : ''}">${m.name}</div>
            <div class="msg-text">${m.text}</div>
            <div class="msg-time">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
        `;
        container.appendChild(div);
        div.scrollIntoView({behavior: 'smooth'});
    });
}

// 9. –°–ü–ò–°–û–ö –ß–ê–¢–û–í (–¢–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –≤—ã —É–∂–µ –æ–±—â–∞–ª–∏—Å—å)
function loadChats() {
    const container = document.getElementById('chat-list');
    container.innerHTML = `
        <div class="chat-item" onclick="openPublic()">
            <div class="avatar">üåê</div>
            <div class="info"><div class="chat-name">–û–±—â–∏–π —á–∞—Ç</div><div class="last-msg">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div></div>
        </div>`;

    db.ref('private_chats').on('value', snap => {
        container.querySelectorAll('.private').forEach(el => el.remove());
        snap.forEach(child => {
            const id = child.key;
            if (id.includes(myUid)) {
                const data = child.val();
                const item = document.createElement('div');
                item.className = 'chat-item private';
                item.innerHTML = `
                    <div class="avatar">üí¨</div>
                    <div class="info">
                        <div class="chat-name">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</div>
                        <div class="last-msg">${data.lastMsg || ''}</div>
                    </div>`;
                item.onclick = () => {
                    currentChatId = id;
                    showChatScreen('–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç', 'üí¨');
                    listenToMessages(`private_chats/${id}/messages`);
                };
                container.appendChild(item);
            }
        });
    });
}

function openPublic() {
    currentChatId = 'public';
    showChatScreen('–û–±—â–∏–π —á–∞—Ç', 'üåê');
    listenToMessages('public_messages');
}

function showChatScreen(title, avatar) {
    document.getElementById('main').style.display = 'none';
    document.getElementById('chat-screen').style.display = 'flex';
    document.getElementById('partner-name').innerText = title;
    document.getElementById('partner-avatar').innerText = avatar;
}

function back() {
    document.getElementById('chat-screen').style.display = 'none';
    document.getElementById('main').style.display = 'flex';
}

document.getElementById('send-btn').onclick = sendMessage;
    </script>
</body>
</html>


